' Gambas class file

Private rstResultado As Result
'
Private picActivo As Picture = Picture.Load("images/alta.png")
Private picBaja As Picture = Picture.Load("images/baja.png")
Private picCerrado As Picture = Picture.Load("images/cerrado.png")
Private picWarn As Picture = Picture.Load("images/warning.png")
Private picCalendar As Picture = Picture.Load("images/calendar_20.png")
Private sFiltroPro As String = "%"
Private sFiltroReq As String = "%"
Private sTipo As String = "%"

Public Sub Form_Open()
  
  Me.Title = "Requerimientos"
  
  txtCodigo.Select
  
  EnviarFiltro()
  ' Requerimientos
  rstResultado = cRequerimientos.GetReqByProy(sFiltroReq)
  CargaGrid()
  
End

Public Sub txtFiltroProy_KeyRelease()
  
  sFiltroPro = txtFiltroProy.Text
  
  EnviarFiltro()
  
End

Public Sub SwitchButton1_Click()
  
  If SwitchButton1.Value = "T" Then 
    sTipo = "-"    
  Else    
    sTipo = "%"    
  Endif
  
  EnviarFiltro()
  
End

Public Sub EnviarFiltro()
  
  rstResultado = cProyectos.FiltrarProyectos(sFiltroPro, sTipo)
  rstResultado.MoveFirst
  lsvProyectos.Clear
  Do While rstResultado.Available 
    ' Proyectos cerrados con clientes Activos
    If rstResultado!P_CERRADO = "+" And rstResultado!C_BAJA = "-" Then
      lsvProyectos.Add(rstResultado!ID_PROYECTO, " - " & rstResultado!COD_PROYECTO, picCerrado)      
      ' Proyectos que est√°n de Baja con el clientes Activo
    Else If rstResultado!P_BAJA = "+" And rstResultado!C_BAJA = "-" Then
      lsvProyectos.Add(rstResultado!ID_PROYECTO, " - " & rstResultado!COD_PROYECTO, picBaja)
      ' Clientes de Baja
    Else If rstResultado!C_BAJA = "+" Then
      lsvProyectos.Add(rstResultado!ID_PROYECTO, " - " & rstResultado!COD_PROYECTO, picWarn)
      ' El resto se consideran activos
    Else
      lsvProyectos.Add(rstResultado!ID_PROYECTO, " - " & rstResultado!COD_PROYECTO, picActivo)
    Endif
    
    rstResultado.MoveNext
  Loop
  
End

' 
Public Sub FiltroRequerimientos()
  
  rstResultado = cProyectos.FiltrarRequerimientos(sFiltroReq, sTipo)
  rstResultado.MoveFirst
  lsvProyectos.Clear
  Do While rstResultado.Available 
    
    If rstResultado!P_CERRADO = "+" And rstResultado!C_BAJA = "-" Then
      lsvProyectos.Add(rstResultado!ID_PROYECTO, " - " & rstResultado!COD_PROYECTO, gConst.picCerrado)
    Else If rstResultado!P_BAJA = "+" And rstResultado!C_BAJA = "-" Then
      lsvProyectos.Add(rstResultado!ID_PROYECTO, " - " & rstResultado!COD_PROYECTO, gConst.picBaja)
    Else If rstResultado!C_BAJA = "+" Then
      lsvProyectos.Add(rstResultado!ID_PROYECTO, " - " & rstResultado!COD_PROYECTO, gConst.picWarn)
    Else
      lsvProyectos.Add(rstResultado!ID_PROYECTO, " - " & rstResultado!COD_PROYECTO, gConst.picActivo)
    Endif
    
    rstResultado.MoveNext
  Loop
  
End

Public Sub btnLimpiar_Click()
  
  ' Reiniciamos los filtros 
  SwitchButton1.value = ""
  
End

Public Sub txtFiltroReq_KeyRelease()
  
  sFiltroReq = txtFiltroReq.Text
  
  rstResultado = cRequerimientos.GetReqByProy(sFiltroReq)
  CargaGrid()
  
End

Public Sub CargaGrid()
  
  Dim i As Integer = 0
  
  GridView1.Clear
  
  GridView1.Columns.Count = rstResultado.Fields.Count - 1
  GridView1.Header = rstResultado.Fields.Count - 1
  GridView1.Columns[0].Title = "ID_REQUERIMIENTO"
  GridView1.Columns[1].Title = "COD_PROYECTO"
  GridView1.Columns[2].Title = "COD_REQ."
  GridView1.Columns[3].Title = "DESCRIPCION"
  GridView1.Columns[4].Title = ""
  
  GridView1.Columns[0].width = 0
  GridView1.Columns[0].Resizable = False
  GridView1.Columns[1].width = 100
  GridView1.Columns[1].Resizable = False
  GridView1.Columns[2].width = 100
  GridView1.Columns[2].Resizable = False
  GridView1.Columns[3].width = 225
  GridView1.Columns[3].Resizable = False
  GridView1.Columns[4].width = 25
  GridView1.Columns[4].Alignment = 3
  GridView1.Columns[4].Resizable = False
  
  '::::::::::::::::::::::::::::::::::::::::::::::::::::
  
  rstResultado.MoveFirst
  
  Do While rstResultado.Available
    GridView1.Rows.Insert(i, 1)
    GridView1[i, 0].Text = rstResultado!ID_REQUERIMIENTO
    GridView1[i, 1].Text = rstResultado!COD_PROYECTO
    GridView1[i, 2].Text = rstResultado!COD_REQUERIMIENTO
    GridView1[i, 3].Text = rstResultado!DESCRIPCION
    If rstResultado!ES_BAJA = "+" Then
      GridView1[i, 4].Picture = picBaja      
    Else If rstResultado!ES_CERRADO = "+"
      GridView1[i, 4].Picture = picCerrado
    Else
      GridView1[i, 4].Picture = picActivo
    End If
    
    i += 1
    rstResultado.MoveNext
  Loop
  
End

Public Sub lsvProyectos_Select()
  
  rstResultado = cRequerimientos.GetReqById(CInt(lsvProyectos.Key))
  CargaGrid()
  
End

Public Sub txtFiltroReq_GotFocus()
  
  txtFiltroProy.Clear
  sFiltroPro = "%"
  EnviarFiltro()
  
End

Public Sub txtFiltroProy_GotFocus()
  
  txtFiltroReq.Clear
  sFiltroReq = "%"
  rstResultado = cRequerimientos.GetReqByProy(sFiltroReq)
  CargaGrid()
  
End

Public Sub lsvProyectos_Click()
  
  gEstructuras.setIdProyecto(lsvProyectos.key)
  
End

Public Sub btnAdd_Click()
  'Hacemos visible los botones de Aceptar y Cancelar
  
  btnAceptar.Visible = True
  btnCancelar.Visible = True
  btnAdd.Enabled = False
  
  txtCodigo.Text = gUtils.GetCodigo("REQ")
  
End

Public Sub btnSalir2_Click()
  
  Me.Close()
  MenuPrincipal.Show()
  
End

Public Sub btnAceptar_Click()
  
  btnAdd.Enabled = True
  
  If Len(Trim(txtCodigo.Text)) = 0 Or Len(Trim(txaDescripcion.Text)) = 0 Then
    If Len(Trim(txaDescripcion.Text)) = 0 Then 
      txaDescripcion.Background = Color.Red
    Else 
      txaDescripcion.Background = Color.White
    End If
    ' Aviso por pantalla al usuario
    Message.Warning("Debe cumplimentar los datos marcados en rojo")
    
  Else
    txtCodigo.Background = Color.White
    txaDescripcion.Background = Color.White
    
  Endif
  
End
