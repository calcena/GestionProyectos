' Gambas class file

Private rstResultado As Result
Private sFiltro As String = "%"
Private sEstado As String = "%"

Public Sub btnSalir2_Click()
  
  Me.Close()
  MenuPrincipal.Show()
  
End

Public Sub Form_Open()
  ' Cargamos el ResultSet con los filtros
  
  CargarGrid()
  
  ComboRoles()
  
End

Public Sub ComboRoles()
  
  cmbRol.Clear()
  
  rstResultado = cRoles.GetAllRoles()
  
  rstResultado.MoveFirst
  
  cmbRol.tag = New Integer[]
  
  cmbRol.Add("- Todos -")
  cmbRol.tag.add(0)
  Do While rstResultado.Available
    
    cmbRol.Add(rstResultado!NOMBRE)
    cmbRol.tag.add(rstResultado!ID_ROL)  
    rstResultado.MoveNext  
  Loop
  
End

Public Sub txtFiltroUsuarios_KeyRelease()
  
  sFiltro = txtFiltroUsuarios.Text
  CargarGrid()
  
End

Public Sub GetRows() 
  
  Dim resultado As String 
  
  resultado = CStr(rstResultado.Count)
  lblRegistros.Text = "Registros: " & resultado 
  
End

Public Sub CargarGrid()  
  
  rstResultado = cUsuarios.GetUsers(sFiltro, sEstado)
  ' obtenemos los registro para pintar el grid  
  grvUsuarios = cUsuarios.GetGrid(grvUsuarios, rstResultado)
  
  GetRows()
  
End

Public Sub btnAdd_Click()
  
  ' se hacen visible los botones de Aceptar y Cancelar acción
  btnAceptar.Visible = True
  btnCancelar.visible = True
  btnAdd.Enabled = False
  txtCodigo.Text = gUtils.GetCodigo("USU")
  
  ' Creamos un nuevo registro
  cUsuarios.AddUsuario(txtCodigo.Text)
  
End

Public Sub btnAceptar_Click()
  
  If Len(Trim(txtNombre.text)) = 0 Or Len(Trim(txtApellido1.text)) = 0 Or Len(Trim(txtApellido2.text)) = 0 Or Len(Trim(txtPass.text)) = 0 Or Len(Trim(txtPass2.text)) = 0 Then 
    'nombre
    If Len(Trim(txtNombre.text)) = 0 Then 
      txtNombre.Background = Color.Red
    Else
      txtNombre.Background = Color.white
    End If 
    'apellido1
    If Len(Trim(txtApellido1.text)) = 0 Then 
      txtApellido1.Background = Color.Red
    Else
      txtApellido1.Background = Color.white
    End If
    'apellido2
    If Len(Trim(txtApellido2.text)) = 0 Then 
      txtApellido2.Background = Color.Red
    Else
      txtApellido2.Background = Color.White
    End If
    'password
    If Len(Trim(txtPass.text)) = 0 Then 
      txtPass.Background = Color.Red
    Else
      txtPass.Background = Color.white
    End If
    'repetir password
    If Len(Trim(txtPass2.text)) = 0 Then 
      txtPass2.Background = Color.Red
    Else
      txtPass2.Background = Color.white      
    End If
    ' Aviso por pantalla al usuario
    Message.Warning("Debe cumplimentar los datos marcados en rojo")
  Else 
    
    cUsuarios.EditUsuario(txtCodigo.Text, txtPass.Text, txtNombre.Text, txtApellido1.Text, txtApellido2.Text, cmbRol.Tag[cmbRol.index])
    
    btnLimpiar_Click()
    btnAceptar.visible = False
    btnCancelar.visible = False
    
  Endif
  
End

Public Sub btnLimpiar_Click()
  
  txtCodigo.Text = Null
  txtNombre.Text = Null
  txtApellido1.Text = Null
  txtApellido2.Text = Null
  txtPass.Text = Null
  txtPass2.text = Null
  cmbRol.index = 0 
  
End

Public Sub swbEstado_Click()
  ' Pulsamos el switch button
  
  If swbEstado.value = "T" Then 
    ' Activos
    sFiltro = "-"
    CargarGrid()
  Else
    'Todos
    sFiltro = "%"
    CargarGrid()
  Endif
  
End

Public Sub txtNombre_LostFocus()
  
  ActivarLimpiar()
  
End

Public Sub ActivarLimpiar()
  ' 
  
  If Len(txtNombre.text) > 0 And Len(txtApellido1.text) > 0 And Len(txtapellido2.text) > 0 And Len(txtPass.text) > 0 And Len(txtpass2.text) > 0 Then
    btnLimpiar.Enabled = True
  Else
    btnLimpiar.Enabled = False
  Endif
  
End

Public Sub grvUsuarios_Click()
  ' Guardamos el ID seleccionado
  
  gEstructuras.setIdSeleccion(grvUsuarios[grvUsuarios.Row, 0].text)
  ' Recogemos los datos del item seleccionado para modo edición
  rstResultado = cUsuarios.GetSelectedUser(gEstructuras.getIdSeleccion())
  
  If rstResultado.Available Then
    rstResultado.MoveFirst
    
    Do While rstResultado.Available
      txtCodigo.Text = rstResultado!COD_USUARIO
      txtNombre.Text = rstResultado!NOMBRE
      txtPass.Text = rstResultado!PASSWORD
      txtApellido1.text = rstResultado!APELLIDO1
      txtApellido2.Text = rstResultado!APELLIDO2      
      'cmbRol.Tag = rstResultado!ID_ROL
      rstResultado.MoveNext
    Loop
    
  Endif
  
End
