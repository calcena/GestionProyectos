' Gambas class file

Private sFiltro As String = "%"
Private sFiltroTask As String = "%"
Private rstResultado As Result
Private i As Integer = 0
Private n As Integer = 0
Dim strObjeto As GObjects = New GObjects
  
Public Sub Form_Open()
  
  Dim n As Integer = 0
  
  Me.Title = "Tareas"
  
  IniBuscadores()
  
  rstResultado = cTareas.GetTaskByFilter(sFiltroTask)
  
  grvTareas = cTareas.GetGrid(grvTareas, rstResultado)
  
  ' InicializarGrid()
  
End

Public Sub IniBuscadores()
  
  'ListView de Proyectos
  rstResultado = cProyectos.FiltrarProyectos(sFiltro, "-")
  rstResultado.MoveFirst
  lsvProyectos.Clear
  Do While rstResultado.Available 
    ' Proyectos cerrados con clientes Activos
    If rstResultado!P_BAJA = "+" And rstResultado!C_BAJA = "-" Then
      lsvProyectos.Add(rstResultado!ID_PROYECTO, " - " & rstResultado!COD_PROYECTO, gConst.picBaja) 
      ' Clientes de Baja
    Else If rstResultado!C_BAJA = "+" Then
      lsvProyectos.Add(rstResultado!ID_PROYECTO, " - " & rstResultado!COD_PROYECTO, gConst.picWarn)
      ' El resto se consideran activos
    Else
      lsvProyectos.Add(rstResultado!ID_PROYECTO, " - " & rstResultado!COD_PROYECTO, gConst.picActivo)
    Endif
    
    rstResultado.MoveNext
  Loop
  
  'ListView de Requerimientos
  'Cargamos los Datos de los Requerimientos Activos
  rstResultado = ctareas.GetReqByFilter(sFiltro)
  rstResultado.MoveFirst
  lsvRequeremientos.Clear
  Do While rstResultado.Available 
    
    If rstResultado!ES_CERRADO = "+" Then
      lsvRequeremientos.Add(rstResultado!ID_REQUERIMIENTO, " - " & rstResultado!COD_REQUERIMIENTO, gConst.picCerrado)
    Else If rstResultado!ES_BAJA = "+" Then
      lsvRequeremientos.Add(rstResultado!ID_REQUERIMIENTO, " - " & rstResultado!COD_REQUERIMIENTO, gConst.picBaja)
      
    Else
      lsvRequeremientos.Add(rstResultado!ID_REQUERIMIENTO, " - " & rstResultado!COD_REQUERIMIENTO, gConst.picActivo)
    Endif
    
    rstResultado.MoveNext
  Loop
  
End

Public Sub txtFiltro_KeyRelease()
  ' Filtramos en contenido de los buscadores segun palabras introducidas
  
  sFiltro = txtFiltro.Text
  IniBuscadores()
  
End

Public Sub InicializarGrid()
  
  grvTareas.Columns.Count = rstResultado.Fields.Count - 1
  grvTareas.Header = rstResultado.Fields.Count - 1
  
  grvTareas.Columns[0].Title = "ID_TAREA"
  grvTareas.Columns[1].Title = "COD_TAREA"
  grvTareas.Columns[2].Title = "DESCRIPCION"
  grvTareas.Columns[3].Title = ""
  
  grvTareas.Columns[0].width = 0
  grvTareas.Columns[0].Resizable = False
  grvTareas.Columns[1].width = 100
  grvTareas.Columns[1].Resizable = False
  grvTareas.Columns[2].width = 425
  grvTareas.Columns[2].Resizable = False
  grvTareas.Columns[3].width = 25
  grvTareas.Columns[3].Resizable = False
  
End

' Public Sub CargarGrid()
'   

'   grvTareas.Columns.Count = rstResultado.Fields.Count - 1
'   grvTareas.Header = rstResultado.Fields.Count - 1
'   
'   grvTareas.Columns[0].width = 0
'   grvTareas.Columns[0].Resizable = False
'   grvTareas.Columns[1].width = 100
'   grvTareas.Columns[1].Resizable = False
'   grvTareas.Columns[2].width = 425
'   grvTareas.Columns[2].Resizable = False
'   grvTareas.Columns[3].width = 25
'   grvTareas.Columns[3].Resizable = False
'   
'   '::::::::::::::::::::::::::::::::::::::::::::::::::::
'   
'   rstResultado.MoveFirst
'   
'   Do While rstResultado.Available
'     grvTareas.Rows.Insert(i, 1)
'     grvTareas[i, 0].Text = rstResultado!ID_TAREA
'     grvTareas[i, 1].Text = rstResultado!COD_TAREA
'     grvTareas[i, 2].Text = rstResultado!DESCRIPCION
'     If rstResultado!ES_BAJA = "+" Then
'       grvTareas[i, 3].Picture = gConst.picBaja      
'     Else If rstResultado!ES_CERRADO = "+"
'       grvTareas[i, 3].Picture = gConst.picCerrado
'     Else
'       grvTareas[i, 3].Picture = gConst.picActivo
'     End If
'     
'     i += 1
'     rstResultado.MoveNext
'   Loop
'   
' End

'Funcion que para cargar el Grid con la parte escrita en el buscador 
Public Sub txtFiltro2_KeyRelease()
  
  sFiltroTask = txtFiltro2.Text
  
  rstResultado = cTareas.GetTaskByFilter(sFiltroTask)
  'CargarGrid()
  grvTareas = cTareas.GetGrid(grvTareas, rstResultado)
  
End

Public Sub btnAdd_Click()
  
  ' Comprobación de valores entrados datos obligatorios
  
  If Len(Trim(txtCodTarea.Text)) = 0 Or Len(Trim(txtDescripcion.Text)) = 0 Or Len(Trim(txtHorasPrevistas.text)) = 0 Or Len(Trim(dbFechaFinalizacion.Text)) = 0 Then  
    '   'Codigo de Tarea
    If Len(Trim(txtCodTarea.Text)) = 0 Then 
      txtCodTarea.Background = Color.Red
    Else 
      txtCodTarea.Background = Color.White
    End If
    '   ' Descripción 
    If Len(Trim(txtDescripcion.Text)) = 0 Then 
      txtDescripcion.Background = Color.Red
    Else 
      txtDescripcion.Background = Color.White
    End If
    '   ' Horas previstas
    If Len(Trim(txtHorasPrevistas.Text)) = 0 Then 
      txtHorasPrevistas.Background = Color.Red
    Else 
      txtHorasPrevistas.Background = Color.White
    End If
    '   ' Fecha finalización
    If Len(Trim(dbFechaFinalizacion.Text)) = 0 Then 
      dbFechaFinalizacion.Background = Color.Red
    Else 
      dbFechaFinalizacion.Background = Color.White
      
    End If
    ' Aviso por pantalla al usuario
    Message.Warning("Debe cumplimentar los datos marcados en rojo")
  Else
    txtCodTarea.Background = Color.White
    txtDescripcion.Background = Color.White
    txtHorasPrevistas.Background = Color.White
    dbFechaFinalizacion.Background = Color.White
  End If
  
End

Public Sub lsvProyectos_Click()
  
  strObjeto.
  
  .SetIdProyecto(lsvProyectos.Key)
  
End
